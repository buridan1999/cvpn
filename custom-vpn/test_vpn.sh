#!/bin/bash

echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ VPN –°–µ—Ä–≤–µ—Ä–∞ ==="

# –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ HTTP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ HTTP —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 9999..."
cd /tmp && python3 -m http.server 9999 > /dev/null 2>&1 &
LOCAL_SERVER_PID=$!
sleep 1

# –ó–∞–ø—É—Å–∫ VPN —Å–µ—Ä–≤–µ—Ä–∞
echo "–ó–∞–ø—É—Å–∫ VPN —Å–µ—Ä–≤–µ—Ä–∞..."
cd "$(dirname "$0")/build"
./custom-vpn > vpn_server.log 2>&1 &
VPN_SERVER_PID=$!
sleep 2

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
if ! ss -tulpn | grep :8080 > /dev/null; then
    echo "‚ùå VPN —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

if ! ss -tulpn | grep :9999 > /dev/null; then
    echo "‚ùå –¢–µ—Å—Ç–æ–≤—ã–π HTTP —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"

# –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
echo ""
echo "üß™ –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É HTTP —Å–µ—Ä–≤–µ—Ä—É"
if timeout 5s ./test-client 127.0.0.1 8080 127.0.0.1:9999 > test1.log 2>&1; then
    echo "‚úÖ –¢–µ—Å—Ç 1 –ø—Ä–æ–π–¥–µ–Ω - –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå –¢–µ—Å—Ç 1 –ø—Ä–æ–≤–∞–ª–µ–Ω"
    cat test1.log
fi

# –¢–µ—Å—Ç 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ httpbin.org (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
echo ""
echo "üß™ –¢–µ—Å—Ç 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–º—É —Å–µ—Ä–≤–µ—Ä—É (httpbin.org)"
if timeout 10s ./test-client 127.0.0.1 8080 httpbin.org:80 > test2.log 2>&1; then
    echo "‚úÖ –¢–µ—Å—Ç 2 –ø—Ä–æ–π–¥–µ–Ω - –≤–Ω–µ—à–Ω–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ö†Ô∏è  –¢–µ—Å—Ç 2: –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–Ω–µ—à–Ω–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Å—Ä–µ–¥–∞—Ö)"
fi

# –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
echo ""
echo "üß™ –¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤"
if timeout 5s ./test-client 127.0.0.1 8080 192.0.2.1:80 > test3.log 2>&1; then
    echo "‚ö†Ô∏è  –¢–µ—Å—Ç 3: –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —É—Å–ø–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º—É –∞–¥—Ä–µ—Å—É"
else
    echo "‚úÖ –¢–µ—Å—Ç 3 –ø—Ä–æ–π–¥–µ–Ω - —Å–µ—Ä–≤–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏"
fi

echo ""
echo "=== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ VPN —Å–µ—Ä–≤–µ—Ä–∞ ==="
echo "–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:"
ss -tulpn | grep :8080 || echo "VPN —Å–µ—Ä–≤–µ—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"

echo ""
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –∏–∑ –ª–æ–≥–∞ VPN —Å–µ—Ä–≤–µ—Ä–∞:"
tail -10 vpn_server.log 2>/dev/null || echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –û—á–∏—Å—Ç–∫–∞
echo ""
echo "üßπ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤..."
kill $VPN_SERVER_PID $LOCAL_SERVER_PID 2>/dev/null
wait $VPN_SERVER_PID $LOCAL_SERVER_PID 2>/dev/null

echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"